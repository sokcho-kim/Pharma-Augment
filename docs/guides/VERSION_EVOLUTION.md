# Pharma-Augment 버전별 진화 과정

## 📋 개요

한국 요양급여 심사 도메인 질문 생성 프로젝트의 버전별 발전 과정과 각 버전의 특징을 정리한 문서입니다.

## 🔄 버전 진화 과정

### V1: 기본 질문 생성 (Initial Release)
**목표**: 기본적인 질문 생성 시스템 구축

**특징**:
- 기본적인 WH 질문 중심
- 길이/품질 필터링
- 단순한 템플릿 기반 생성

**한계**:
- 질문의 다양성 부족
- 임베딩 모델에 최적화되지 않음
- 대명사 사용 제한 없음

---

### V2: 임베딩 최적화 (Embedding Optimized)
**목표**: 임베딩 학습에 최적화된 질문 생성

**특징**:
- **평균 질문 길이**: 36.2자 (15-115자)
- **풍부한 질문 유형**: 5가지 질문 패턴
  - 기본 정보형: "무엇인가요?"
  - 조건/상황형: "언제 사용하나요?" 
  - 비교형: "차이점은?"
  - 절차형: "어떻게 하나요?"
  - 제한형: "제한사항은?"
- **구체적 표현**: 수치, 의료용어, 환자군 명시
- **실무 중심**: 구체적 시나리오 기반

**V2 질문 예시**:
```
✅ "AST 수치가 60U/L 이상일 때 어떤 급여요건이 적용되나요?" (31자)
✅ "간기능 저하 환자에서 용량 조절 기준과 주의사항은?" (27자)
✅ "3개월 이상 장기 처방 시 필요한 모니터링 항목은?" (26자)
```

**성과**: 총 12,866개 고품질 질문 생성

---

### V3: 대명사 차단 + 이름비율 강제 (Strict Compliance)
**목표**: Prompt3.md 스펙에 따른 엄격한 검증 시스템

**특징**:
- **대명사 완전 차단**: `(이|그|해당|본|동)\s?(약|약제|제제|제품)|이것|그것`
- **이름 사용 비율 강제**:
  - MAIN (주약제명): 30-40%
  - BRAND (품명): 30-40%  
  - BOTH (둘 다): 20-30%
- **9개 카테고리 분산**: 범위/요건/오프라벨/기간/전환/증빙/본인부담/대상군/절차
- **엄격한 품질 점수**: S_q ≥ 0.75

**한계**:
- 너무 엄격한 필터링으로 질문 생성 실패 행 발생
- 품질 기준이 과도하여 실용성 저하

---

### V4: 100% 커버리지 보장 (Robust Fallback)
**목표**: 모든 행에서 반드시 질문 생성 보장

**특징**:
- **3단계 Fallback 시스템**:
  1. 1차: 엄격한 V3 기준
  2. 2차: 완화된 기준  
  3. 3차: 기본 질문 생성 (100% 보장)
- **100% 행 커버리지** 달성
- **고정 출력 형식**: 제출용 엑셀 컬럼 순서 준수

**결과**: 688행 → 6,493개 질문 (100% 성공률)

**문제점**:
- 질문 품질 저하 (대부분 fallback 기본 질문)
- 획일적이고 단순한 패턴
- [일반원칙] 등 괄호 패턴이 질문에 포함

---

### V5: 품질 + 커버리지 균형 (Quality Enhanced)
**목표**: V2의 풍부함 + V4의 엄격함을 결합한 최고 품질

**핵심 개선사항**:

1. **V2 스타일 질문 복원**
   - **길이**: 25-80자 (V2 수준)
   - **구체성**: 수치, 의료용어, 구체적 조건 포함 필수
   - **다양성**: 5가지 질문 유형 강제

2. **대명사 완전 차단** (V3/V4 장점 유지)
   - 정규식 기반 100% 검증
   - 질문에서만 제거 (구분 필드는 원본 유지)

3. **품질 중심 필터링**
   - **구체성 검증**: 숫자, 단위, 의료용어 포함 확인
   - **실무성 강화**: 환자군, 절차, 기준 등 포함
   - **창의성 증가**: temperature 0.8

**V5 프롬프트 핵심**:
```python
# V5 Enhanced Generation Rules
1) 질문 길이: 25~80자 (V2 수준으로 구체적)
2) 대명사 절대 금지: "이것", "그것", "해당 약제" 등
3) 질문 유형 다양화:
   - 기본 정보형: "구체적인 급여 인정 기준은?"
   - 조건/상황형: "{수치/조건}일 때 사용 가능한가요?"
   - 비교형: "경구제와 주사제 기준 차이점은?"
4) 실무적 구체성:
   - 구체적 수치 (AST 60U/L, 3개월 등)
   - 환자군 명시 (소아, 성인, 고령자)
   - 의료용어 활용 (간기능, 혈중농도 등)
```

---

## 📊 버전별 성능 비교

| 버전 | 평균 질문 길이 | 질문 품질 | 커버리지 | 대명사 차단 | 특징 |
|------|---------------|-----------|----------|-------------|------|
| V1 | ~20자 | ⭐⭐ | 80% | ❌ | 기본 생성 |
| V2 | 36.2자 | ⭐⭐⭐⭐⭐ | 85% | ❌ | 임베딩 최적화 |
| V3 | ~30자 | ⭐⭐⭐⭐ | 70% | ✅ | 엄격한 검증 |
| V4 | ~25자 | ⭐⭐ | 100% | ✅ | 완전 커버리지 |
| **V5** | **30-50자** | **⭐⭐⭐⭐⭐** | **95%** | **✅** | **품질+커버리지** |

## 🔧 데이터 정리 과정

### 문제 발견
생성된 질문에 **[일반원칙]**, **[심사지침]** 등 괄호 패턴이 포함됨

**문제 예시**:
```
❌ "[일반원칙] 간장제제의 급여 인정 기준은?"
❌ "[심사지침] 프로그랍캅셀 사용법은?"
```

### 해결책 구현

1. **데이터 소스 정리**: `data_cleaner.py`
   - 원본 엑셀에서 [괄호] 패턴 제거
   - 50개 패턴 발견 → 완전 제거

2. **결과 질문 정리**: `question_only_cleaner.py`  
   - **질문 필드만** 괄호 패턴 제거
   - **구분 필드**는 원본 유지 (데이터 무결성)
   - 253개 패턴 제거

**정리 후**:
```
✅ 구분: [일반원칙] 간장제제 (원본 유지)
✅ 질문: 간장제제의 급여 인정 기준은? (깔끔하게 정리)
```

## 🎯 최종 권장사항

### 사용 목적별 버전 선택

1. **최고 품질 원할 때**: **V5 권장**
   - V2 수준의 풍부한 질문
   - 대명사 완전 차단
   - 구체적이고 실무적

2. **100% 커버리지 필요할 때**: V4 사용
   - 모든 행에서 반드시 질문 생성
   - 품질보다 완성도 우선

3. **임베딩 모델 학습용**: V2 또는 V5
   - 다양하고 구체적인 질문
   - 학습 데이터 품질 최적화

### V5 실행 방법

```bash
cd C:\Jimin\Pharma-Augment\versions\v5

# 정리된 데이터로 V5 실행
python drug_generator_v5.py \
  --excel "../../data/요양심사약제_후처리_v2_cleaned.xlsx" \
  --out "drug_questions_v5.xlsx" \
  --concurrency 4
```

### 기대 결과 (V5)
- **평균 질문 길이**: 35-45자
- **질문 품질**: V2 수준
- **대명사 사용률**: 0%  
- **성공률**: 95% 이상
- **구체성**: 의료 수치, 환자군, 절차 포함

---

## 📈 향후 개선 방향

1. **고시 데이터 대응**: V5 스타일의 고시 전용 생성기 개발
2. **멀티모달 확장**: 이미지, 표 데이터 포함 질문 생성
3. **도메인 특화**: 진료과별, 질환별 특화 질문 패턴
4. **품질 자동 평가**: 의료 전문가 평가 기준 자동화
5. **실시간 검증**: API 호출 중 실시간 품질 검증 시스템

---

*최종 업데이트: 2025-09-03*  
*작성자: Claude Code Assistant*