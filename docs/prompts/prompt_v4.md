# 무적의 버전 생성 지시서 

* **질문 수**: 각 행(약제/고시)당 **최소 5개 \~ 최대 20개**
* **최종 출력 형식(제출용)**: `약제분류번호, 약제 분류명, 구분, 세부인정기준 및 방법, question, 라벨`
* **라벨**: `POSITIVE | NEGATIVE | HARD_NEGATIVE` (HARD\_NEG는 팀장님 특별주문 “얼핏 관련처럼 보이지만 실제론 어긋나는 near-miss”)
* **대명사 금지**: “이/그/해당/본/동 + (약/약제/제제/제품), 이것/그것” 일절 금지
* **하드 네거티브 생성법**: ReasonIR 논문식 **멀티턴 하드네거티브** 절차를 반영(18p 시스템 프롬프트 요지) , 해당 섹션 설명 반영&#x20;

---

# ⚔ 무적 프롬프트 v4 — DRUG(약제)용

```
[ROLE]
너는 의료 보험 심사·수가 약제 데이터를 임베딩 학습용 질문 세트로 변환하는 에이전트다.
입력 1행(약제 단위)을 받아 질문을 최소 5개~최대 20개 생성하고, 각 질문에 라벨을 부여한다.
최종 제출 형식은 반드시 아래 6개 필드만을 가지는 JSON 배열이다.

[INPUT]
- 약제분류번호: {string}
- 약제 분류명: {string}
- 구분: {string}   # 예: "Tacrolimus 제제 (품명: 프로그랍캅셀·주사)"
- 세부인정기준 및 방법: """{string}"""

[NAME SLOTS] (프롬프트 내부 추출 규칙)
- main_name = 구분에서 괄호 앞의 주 약제명(예: "Tacrolimus 제제")
- brand_names = "품명:" 뒤의 품명들을 '·' 또는 '/' 기준으로 분리 트림
  없으면 빈 배열([])

[GENERATION RULES]
1) 질문 수: 5~20개. 생성 가능한 만큼 만들되 품질 필터 통과분만 채택.
2) 문형: WH 개방형(무엇/어떤/언제/어떻게/왜), 1문장 1논점, 외부 지식/추정 금지.
3) 길이: 15~70자(훈련 기준). 12~50자는 검증셋 추출 시 가점.
4) 대명사 금지: "(이|그|해당|본|동) (약|약제|제제|제품)|이것|그것" 포함 시 폐기·재생성.
5) 이름 사용 비율(세트 수준 강제):
   - MAIN(주 약제명만 포함) 30–40%
   - BRAND(품명만 포함)     30–40%
   - BOTH(둘 다 포함)        20–30%
   - brand_names == [] 이면: MAIN 70–80%, BOTH 20–30%
   - brand_names 길이 == 1 이면: MAIN 35–45%, BRAND 30–40%, BOTH 20–30%
   - 검증: MAIN이면 brand 미포함, BRAND면 main 미포함, BOTH면 둘 다 포함.
6) 카테고리(질문마다 정확히 1개 부여, 세트 내 최소 4종 이상 등장, 단일 카테고리 ≤ 40%)
   {범위, 요건/기준, 오프라벨/허가범위, 기간/시점, 전환(경구↔주사),
    증빙/서류, 본인부담/급여구분, 대상군, 절차/프로세스}
7) DRUG 세트에서 특히 포함 권장: 기간/시점, 전환(경구↔주사), 본인부담, 대상군 특례.

[LABELING]
- POSITIVE: 본 입력(구분/세부인정기준)에 직접 부합하는 질문.
- NEGATIVE: 전혀 다른 약제·조항을 전제로 한 명백히 무관한 질문.
- HARD_NEGATIVE: 표면 토큰은 유사하나 핵심 차원이 어긋나는 near-miss
  (예: 같은 약제지만 ‘조혈모세포이식’↔‘신장이식’, ‘성인’↔‘소아’, ‘초기’↔‘재발’,
   ‘경구’↔‘주사’, ‘급여’↔‘전액 본인부담’, ‘기간 A’↔‘기간 B’ 등).

[SELF-CHECK & SCORING]
문항 점수 S_q (0~1):
- length_score = clip(1 - |len-45|/30, 0, 1)
- wh_score     = 1 if 문두 WH, 0.6 if WH 포함, else 0.2
- single_issue = 1 if (','+'및'+'/' 합계) ≤ 1 else 0.3
- pronoun_penalty = -1 if 대명사 패턴 존재 else 0
- overlap = 원문 핵심토큰과의 교집합 비율(0~1)  # 0.4~0.9가 이상적
- S_q = 0.25*length + 0.25*wh + 0.25*single_issue + 0.25*overlap + pronoun_penalty
기준: S_q ≥ 0.75만 채택. 미달 1회 재작성, 그래도 미달이면 폐기.

세트 점수 S_set (0~1):
- name_ratio_dev = Σ_k max(0, |obs_k - target_k| - 0.05)  # k∈{MAIN,BRAND,BOTH}
- cat_coverage   = unique_categories / max(4, min(9, N))
- max_cat_ratio  = 세트에서 최빈 카테고리 비중
- S_set = 0.5*cat_coverage + 0.5*(1 - min(1, 2*name_ratio_dev)) - max(0, max_cat_ratio-0.4)
기준: S_set ≥ 0.7. 미달 시 부족 카테고리/이름사용으로 추가 생성·치환 후 재계산.

[LABEL 분포 게이트(권장)]
- 세트 내 POSITIVE ≥ 60%, HARD_NEGATIVE 10~25%, NEGATIVE 10~25%.
- N<5이면 추가 생성, N>20이면 S_q 낮은 순으로 20개만 남김.

[OUTPUT — 제출용 고정 스키마(JSON 배열만 출력)]
[
  {"약제분류번호":"...","약제 분류명":"...","구분":"...","세부인정기준 및 방법":"...","question":"...","라벨":"POSITIVE|NEGATIVE|HARD_NEGATIVE"},
  ...
]
```

---

# ⚔ 무적 프롬프트 v4 — NOTICE(고시)용

```
[ROLE]
너는 의료 보험 심사·수가 고시 조항을 임베딩 학습용 질문 세트로 변환하는 에이전트다.
입력 1행(고시 조항 단위)을 받아 질문 5~20개 생성 및 라벨 부여.

[INPUT]
- 고시번호, 고시명칭, 변경 전 내용, 변경 후 내용 

[GENERATION RULES]
- DRUG 규칙을 모두 상속(대명사 금지, 이름비율, 카테고리·길이·1문장1논점).
- NOTICE 특화 유형을 반드시 분산 포함:
  (a) 수가/코드, (b) 급여↔비급여 전환 조건, (c) 삭감/이의신청,
  (d) 필수 제출 서류, (e) 개정 전후 비교(연·월 기준 명시).
- 질문은 반드시 본 고시 문구에 직접 근거(외부 추정 금지).

[LABELING]
- POSITIVE: 해당 고시 조항에 직접 부합.
- NEGATIVE: 타 조항·타 약제 기준을 전제(무관).
- HARD_NEGATIVE: 문구 일부는 비슷하지만 핵심 요건이 다른 near-miss
  (성인↔소아, 초진↔재진, 기간/횟수 경계 상이, 경구↔주사, 대상군/특례 상이 등).

[SELF-CHECK/SCORING/분포/출력]
- DRUG와 동일.

[OUTPUT — 제출용 고정 스키마(JSON 배열만 출력)]
[
  {"고시번호":"...","고시명칭":"...","변경후 내용":"...","question":"...","라벨":"POSITIVE|NEGATIVE|HARD_NEGATIVE"},
  ...
]
```

---

## ✨ “좋은 질문” 샘플(대명사 금지, WH, 1문장1논점, Tacrolimus)

* **범위 / MAIN**: “Tacrolimus 제제의 조혈모세포이식 급여 범위는 무엇인가요?”
* **요건/기준 / BRAND**: “프로그랍캅셀을 만성 류마티스관절염에 사용할 때 인정 요건은 무엇인가요?”
* **기간/시점 / BRAND**: “프로그랍주사 사용이 인정되는 치료 기간은 언제부터 언제까지인가요?”
* **전환 / BOTH**: “Tacrolimus(프로그랍주사)로 경구제에서 전환할 때 급여 인정 조건은 무엇인가요?”
* **증빙/서류 / BOTH**: “프로그랍캅셀(Tacrolimus) 처방 청구 시 제출해야 하는 증빙 서류는 무엇인가요?”
* **오프라벨 / MAIN**: “허가 범위를 초과해 Tacrolimus 제제를 사용할 때 급여 인정 기준은 무엇인가요?”
* **본인부담 / BRAND**: “프로그랍 제제가 발·다리 이식에 사용될 때 전액 본인부담이 되는 근거는 무엇인가요?”
* **대상군 / MAIN**: “소아 난치성 신증후군에서 Tacrolimus 제제 사용 인정 조건은 무엇인가요?”
* **절차 / BRAND**: “프로그랍주사 사용을 위해 의료기관이 따라야 하는 사전승인 절차는 무엇인가요?”
* **HARD\_NEG(near-miss)**: “Tacrolimus 제제의 신장이식 환자 급여 인정 기간은 무엇인가요?”
  *(Anchor가 ‘조혈모세포이식 기간’일 때 얼핏 유사하지만 실제로 다른 적응증 → HARD\_NEG)*

---

## 🧠 HARD NEGATIVE 생성 가이드(팀장님 특별주문, 논문 반영)

* **멀티턴 방식**: 먼저 Anchor/Positive를 확정 → 다음 턴에서 **표면 중첩은 있으나 실제론 덜 유용**한 하드네거티브를 생성(문서/질문). ReasonIR는 이런 멀티턴 하드네거티브 프롬프트를 제시하며(도식·프롬프트 예시 포함), “겉보기 관련성 + 핵심 불일치”를 의도적으로 만들라고 권고합니다.&#x20;

> **클로드용 HARD\_NEG 전용 서브프롬프트(추가로 함께 사용)**
> “아래 Anchor 질문과 그 근거 문맥(세부인정기준)을 고려해, **표면 토큰은 유사**하지만 **핵심 요건이 어긋나는** HARD\_NEGATIVE 질문을 1\~3개 생성하라.
> 어긋나게 만들 수 있는 축: 적응증/대상군/연령/기간·횟수 경계/경구↔주사/급여↔전액 본인부담/초진↔재진/필수 서류 유무.
> 단, 원문이 금지·불인정한 케이스를 살짝 비트는 식으로 ‘그럴듯하나 틀린’ 질문을 만들어라.
> 출력은 제출 스키마를 따르고 라벨은 HARD\_NEGATIVE로 고정한다.”

---

## 📐 자체 평가 산식(클로드가 즉시 적용)

* **문항 점수 S\_q ≥ 0.75**만 채택(길이·WH·단일논점·원문중첩·대명사패널티).
* **세트 점수 S\_set ≥ 0.7**: 이름비율 오차(±5% tol) + 카테고리 커버리지(≥4종) + 편중≤40%.
* **라벨 분포**: POS≥60%, HARD\_NEG 10~~25%, NEG 10~~25%.
* **수량**: <5 → 보강 생성, >20 → S\_q 낮은 순 컷.

> 이 산식은 **정합성(원문근거)**, **가독성/학습친화도(WH·길이·단일논점)**, \*\*학습신호 품질(라벨·균형)\*\*을 동시에 담보합니다.

---

## ⚖️ 카테고리 불균형 해결책(실행 가능한 6단계)

1. **Soft Quota**: 세트 내 최소 4카테고리, 단일 ≤40% 강제(프롬프트+사후체크).
2. **라운드로빈 생성**: 부족 카테고리를 우선 큐에 넣어 순환 생성.
3. **가중 재생성**: S\_set 미달 시 부족 카테고리 가중치↑로 추가 생성/치환.
4. **전역 히스토그램 추적**: 배치별 전체 분포를 집계하여 과다 카테고리는 컷, 부족은 우선증강.
5. **HARD\_NEG 축 다양화**: 편중된 축(예: 요건/기준)이 많으면 기간/전환/증빙/절차에서 **near-miss 하드넥**를 의도적으로 늘림(경계 학습 강화).
6. **검증셋 별도 균등화**: 학습셋과 독립된 균등 분포로 검증/테스트 구성(슬라이스 IR 지표 신뢰도 확보).

---

## 🧩 운영 팁(실패 처리 자동화)

* 대명사 적발 → 해당 문항 폐기 후 동일 name\_usage로 재생성.
* 이름비율 미스 → 과다 범주를 다른 name\_usage 문구로 치환해 재균형.
* 다중 논점 → 쉼표·‘및’·‘/’ 2회 이상이면 분리 재작성.
* N<5 → 추가 생성, N>20 → S\_q 낮은 순 컷.

---

위 프롬프트에 맞춰 **검수 스크립트(이름비율·카테고리·S\_q/S\_set 계산)** 템플릿도 생성해 
* 마지막으로 각각의 json을 엑셀로 변환해서 파일 만들어줘(제출용)
