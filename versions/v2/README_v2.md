# Pharma-Augment V2: 임베딩 모델 학습용 향상된 질문 생성기

의료보험 보조 에이전트의 벡터 검색 성능 향상을 위한 **임베딩 모델 학습용** 데이터 생성 도구입니다.

## 🎯 **V2의 핵심 개선사항**

### 1. **약제명/품명 균형 전략** 
- **30%** 주 약제명만 사용: "Tacrolimus 제제의 요양급여..."
- **30%** 품명만 사용: "프로그랍캅셀의 급여 인정..."  
- **25%** 둘 다 사용: "Tacrolimus(프로그랍캅셀)의..."
- **15%** 간접 지칭: "이 약제의...", "해당 치료제의..."

### 2. **질문 유형 다양화 (6가지)**
- **기본형(30%)**: "~의 급여 기준은?", "~은 어떤 질환에?"
- **조건형(25%)**: "~한 경우 ~을 사용할 때", "만약 ~라면"
- **비교형(15%)**: "~와 ~의 차이", "성인과 소아에서"
- **부정형(15%)**: "~가 인정되지 않는 경우", "제한되는 상황"
- **절차형(10%)**: "사전승인 절차", "청구 방법"
- **실무형(5%)**: "삭감 방어", "이의신청"

### 3. **벡터 검색 최적화**
- 더 다양한 표현으로 동일한 의미 질문 생성
- 약어/한글/영문 병기 활용
- 실무 시나리오 기반 질문 포함

## 🚀 **사용법**

### 설치
```bash
pip install -r requirements.txt
```

### 기본 실행
```bash
python generate_questions_v2.py --excel "data/요양심사약제_후처리_v2.xlsx"
```

### 옵션 설정
```bash
python generate_questions_v2.py \
  --excel "data/요양심사약제_후처리_v2.xlsx" \
  --out "embedding_questions_v2.jsonl" \
  --provider "openai" \
  --model "gpt-4o-mini" \
  --concurrency 6 \
  --max_aug 20 \
  --seed 20250902
```

## 📊 **V1 vs V2 비교**

| 항목 | V1 (원본) | V2 (임베딩 최적화) |
|------|-----------|-------------------|
| **목적** | 일반 QA 학습 | 임베딩 모델 학습 |
| **질문 수/조항** | 5~15개 | 15~25개 |
| **약제명 전략** | 단순 활용 | 균형적 분배 (30:30:25:15) |
| **질문 유형** | 5가지 | 6가지 (실무형 추가) |
| **다양성 전략** | 기본 | 고도화된 템플릿 |
| **벡터 검색 고려** | 없음 | 핵심 최적화 |

## 🎯 **예상 성과**

### 생성 데이터
- **688개 조항** → **15,000~20,000개 질문** 예상
- 조항당 평균 **20~25개** 고품질 질문
- **6가지 질문 유형**으로 다양성 확보

### 벡터 검색 성능 향상
- 동일 의미 다양 표현으로 **검색 recall 30%+ 향상**
- 약제명/품명 균형으로 **검색 정확도 향상**
- 실무 시나리오 포함으로 **실용성 향상**

## 📁 **출력 파일**

1. **embedding_questions_v2.jsonl** - JSONL 형식 원본 데이터
2. **embedding_questions_v2_questions.xlsx** - 1행당 1질문 엑셀 형식
3. **audit_log_v2.csv** - 생성 과정 감사 로그
4. **question_generation_v2.log** - 실행 로그

## 🔬 **품질 검증**

### 자동 검증
- 약제명/품명 사용 비율 분석
- 질문 유형 분포 확인
- 중복률 검증 (<1%)
- 길이 분포 확인 (15~200자)

### 수동 검증 권장
- 의료 전문가 검토
- 실무 적합성 평가
- 벡터 검색 테스트

## ⚡ **성능 특징**

- **동시성**: 6개 API 병렬 호출
- **소요시간**: 688개 조항 기준 약 15-20분
- **메모리**: 최적화된 스트리밍 처리
- **에러 복구**: 자동 재시도 및 복구

## 🎓 **임베딩 모델 학습 활용**

```python
# 학습 데이터 구성 예시
{
    "query": "Tacrolimus의 요양급여 인정 기준은?",
    "positive_doc": "허가사항 범위 내에서 아래와 같은 기준으로...",
    "query_alt": [
        "프로그랍캅셀의 급여 인정 기준은?",
        "Tacrolimus(프로그랍캅셀)의 보험 적용 범위는?",
        "이 면역억제제의 급여 기준은?"
    ]
}
```

## 🔧 **고급 설정**

### 약제명 균형 조정
코드에서 `generate_balanced_drug_references()` 함수의 비율 수정 가능

### 질문 템플릿 커스터마이징
`question_templates` 딕셔너리에서 템플릿 추가/수정 가능

### 난이도 조절
`difficulty_modifiers`에서 복잡도 조정 가능

---

**임베딩 모델 학습의 성공을 위한 최적화된 데이터 생성 도구입니다!** 🚀