# V6 질문 생성기 - 약제 전용

## 핵심 변화점

V5에서 V6로의 주요 개선사항 (약제만 처리):

### 1. 데이터 품질 문제 해결
- **고정 데이터 소스**: `C:\Jimin\Pharma-Augment\data\요양심사약제_후처리_v2.xlsx` 사용
- **세부인정기준 및 방법** 컬럼을 올바르게 활용하여 품질 개선

### 2. 생성 방식 전면 변경
- **JSON 금지**: 텍스트 자유생성으로 변경
- **줄단위 질문**: 한 줄에 하나의 질문만 생성
- **강한 전후처리**: 생성 후 엄격한 필터링 적용

### 3. 라벨 비율 조정
- **POS:HN:EN = 6:3:0** (기본)
- EN(NEGATIVE) 기본 제외, 필요시에만 실험적으로 추가

### 4. 품질 게이트 강화
- **대명사 금지**: `이것/그것/해당/본/동` + `약/제제/제품` 패턴 완전 차단
- **구체성 필수**: 숫자/단위/정책어 중 최소 1개 포함
- **단일 논점**: 복합 질문 분리/폐기
- **중복 제거**: RapidFuzz로 유사도 82% 이상 제거

## 주요 특징

### 프롬프트 전략 (약제 전용)
- **영어 프롬프트 → 한국어 출력**: LLM 이해도 향상
- **문두 다양성**: 단일 문두 30% 초과 방지
- **자연스러운 질문**: HN Rewriter로 품질 보장
- **약제만 집중**: 고시 관련 처리 제거로 단순화

### HN(Hard Negative) 생성
- **Facet 기반 변형**: 1개 차원만 의도적으로 변경
- **앵커 기반**: 상위 POS 질문을 기반으로 변형
- **검증 로직**: 핵심 키워드 유지 + 적절한 유사도 확인

### 강한 후처리
- 길이 제한 (25-80자)
- 물음표 필수
- 정규식 기반 품질 검증
- 중복 제거 및 라벨 균형

## 사용법

### 전체 실행
```bash
cd versions/v6
python drug_generator_v6.py
```

### 테스트 실행 (소량)
```bash
cd versions/v6
python test_v6.py
```

### 배치 파일 실행
```bash
versions/v6/run_v6.bat
```

## 출력 형식

엑셀 파일 스키마:
```
약제분류번호 | 약제 분류명 | 구분 | 세부인정기준 및 방법 | question | 라벨
```

라벨:
- `POSITIVE`: 문서 내용에 직접적으로 답할 수 있는 질문
- `HARD_NEGATIVE`: 핵심 키워드는 공유하지만 1개 facet이 다른 질문

## V5 대비 개선점

1. **데이터 무결성**: 세부인정기준 전체 텍스트 활용
2. **생성 안정성**: JSON 파싱 오류 완전 제거  
3. **품질 일관성**: 강한 후처리로 일관된 품질 보장
4. **처리 효율성**: 텍스트 슬라이싱으로 대용량 처리
5. **라벨 균형**: 정확한 6:3:0 비율 달성
6. **단순화**: 약제만 집중 처리로 복잡도 감소

## 파일 구조

```
versions/v6/
├── drug_generator_v6.py    # 메인 생성기
├── test_v6.py             # 테스트 스크립트
├── run_v6.bat             # 실행 배치 파일
├── README_V6.md           # 이 파일
└── [생성 결과들]
    ├── drug_questions_v6.xlsx
    ├── test_v6_results.xlsx
    └── drug_generation_v6.log
```