# V8 개발 계획서

## 🎯 개발 목표

### 1. 핵심 개선사항
- **임베딩 모델 파인튜닝용 고품질 데이터 생성**
- **포괄질문 완전 제거** (적응증은 무엇인가? 등)
- **앵커 데이터 완벽 보존** (약제분류번호, 약제분류명, 구분, 인정기준)
- **실행 시간 단축** (V7: 7.5시간 → V8: 3-4시간)

### 2. 품질 기준 조정
- **약물명/숫자단위**: 필수 → **권장** (LLM 자율성 보장)
- **길이**: 30-250자 (유연한 범위)
- **포괄표현 금지**: "무엇인가", "어떤", "어떻게", "몇" 등
- **구체성 중심**: 특정 상황, 조건, 수치 기반 질문

## 🔧 기술 사양

### 프롬프트 전략
```
임베딩 모델 학습용 의료보험 급여기준 질문을 생성하시오.

권장사항:
- 가능하면 구체적인 약물명 포함 (예: Aspirin, Metformin)
- 수치와 단위 사용 권장 (예: 40mg/dL, 3개월)

필수 요구사항:
- 구체적인 임상 상황 기반 질문
- "무엇인가", "어떤", "어떻게", "적응증은" 등 포괄적 표현 금지
- 명확한 급여기준 관련 질문
- 30-250자 길이
```

### 앵커 데이터 보존 시스템
- 원본 Excel 행 데이터 완벽 매핑
- metadata에 모든 앵커 필드 보존
- Question 생성 시 원본 컨텍스트 유지

### 품질 검증 시스템
```python
def validate_question_quality(question: str) -> Tuple[bool, str]:
    # 포괄표현 검증
    forbidden = ["무엇인가", "어떤", "어떻게", "적응증은", "몇"]
    
    # 구체성 검증 (권장사항)
    has_drug = bool(re.search(r'[A-Z][a-z]{4,}', question))
    has_number = bool(re.search(r'\d+', question))
    
    # 점수 산정 (권장사항 가산점)
    score = base_score + (drug_bonus if has_drug else 0) + (number_bonus if has_number else 0)
```

## 📊 평가 지표

### 1. 데이터 품질 지표
- **포괄질문 제거율**: 99% 이상
- **약물명 포함률**: 70% 이상 (권장)
- **수치 포함률**: 80% 이상 (권장)
- **앵커 데이터 보존율**: 100%

### 2. Triplet Mining 지표
- **목표 Triplet 수**: 200-300개
- **POS:HN 비율**: 2:1 (66.7%:33.3%)
- **총 데이터 수**: 600-900개

### 3. 성능 지표
- **실행 시간**: 4시간 이내
- **API 호출 성공률**: 95% 이상
- **데이터 무결성**: 100%

### 4. 품질 샘플 기준
**✅ 좋은 예시:**
- "간염 환자에서 ALT 수치가 60U/L 이상일 때 Metformin 투여가 금기인가?"
- "당뇨병 환자가 3개월간 Insulin 치료 후 HbA1c 7% 이하 달성시 용량 조정이 필요한가?"

**❌ 나쁜 예시:**
- "Rivaroxaban과 Aspirin 병용요법의 적응증은 무엇인가?" (포괄질문)
- "어떤 경우에 약물치료가 필요한가?" (비구체적)

## 🚀 개발 일정

### Phase 1: 코드 개발 (1시간)
- [ ] V8 생성기 클래스 구현
- [ ] 개선된 프롬프트 시스템
- [ ] 앵커 데이터 보존 로직
- [ ] 실시간 품질 검증

### Phase 2: 테스트 (30분)
- [ ] 3행 테스트 실행
- [ ] 품질 지표 검증
- [ ] 앵커 데이터 무결성 확인

### Phase 3: 전체 실행 (3-4시간)
- [ ] 688행 전체 처리
- [ ] 실시간 모니터링
- [ ] 품질 지표 달성 확인

## 📈 예상 결과

### 최종 데이터셋 예상
- **총 데이터**: 600-900개
- **Triplet 수**: 200-300개
- **약물명 포함**: 70% (420-630개)
- **포괄질문**: 0개
- **앵커 데이터**: 100% 보존

### V7 대비 개선점
- 실행시간: 7.5시간 → 4시간 (47% 단축)
- 품질: 불안정 → 안정적
- 약물명 포함: 9% → 70% (8배 향상)
- 포괄질문: 많음 → 0개

## 🔍 리스크 관리

### 잠재적 위험
1. **LLM 과도한 제약**: 권장사항으로 완화
2. **앵커 데이터 누락**: 매핑 검증 시스템 구축
3. **품질 저하**: 실시간 검증으로 대응

### 대응 방안
- 단계별 검증 시스템
- 체크포인트별 품질 확인
- 사용자 피드백 반영 시스템

---

**목표**: 임베딩 모델 파인튜닝에 최적화된 고품질 의료보험 급여기준 질문 데이터셋 생성